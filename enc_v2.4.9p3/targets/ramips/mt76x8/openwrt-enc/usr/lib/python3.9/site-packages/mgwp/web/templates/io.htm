<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <title>MGWv2</title>

  <link rel="stylesheet" href="style.css">
  <script type="text/javascript" src="common.js"></script>

  <style>
    table,
    th,
    td {
      min-width: 100px;
    }

    input[type="text"] {
      width: 150px;
    }

    input[type="text"].textView {
      width: 50px;
      text-align: left;
      border-width: 0;
    }

    button {
      margin-right: 5px;
      margin-top: 2px;
      margin-bottom: 2px;
      border-width: 1px;
      min-width: 60px;
      height: 24px;
    }

    button:hover {
      border-width: 2px;
    }
  </style>

  <script type="text/javascript">
    function jsOnLoad() {
      jsInitMenu(8);
      jsGET('io.json', jsLoadDone);
    }

    function jsLoadDone(rspText) {
      var j = JSON.parse(rspText);
      devices = j["devices"];
      if (devices != null) {
        updateDevices(devices);
      }
      schedules = j["schedules"];
      if (schedules != null) {
        updateSchedules(schedules);
      }
    }

    function updateDevices(devices) {
      for (let i = 0; i < devices.length; i++) {
        addDevice(devices[i], i + 2);
      }
    }

    function addDevice(d, rowIndex = 0) {
      var tb = jsGetEId("tbDevices");
      var tr = tb.insertRow(rowIndex);
      var td;

      td = tr.insertCell(0);
      var iTxt = document.createElement('input');
      iTxt.type = "text";
      iTxt.name = "txtDev" + d.addr + "Addr";
      iTxt.value = d.addr;
      iTxt.readOnly = true;
      iTxt.className = "textView";
      td.appendChild(iTxt);

      td = tr.insertCell(1);
      var iTxt = document.createElement('input');
      iTxt.type = "text";
      iTxt.name = "txtDev" + d.addr + "Name";
      iTxt.value = d.name;
      td.appendChild(iTxt);

      td = tr.insertCell(2);
      var iChk = document.createElement('input');
      iChk.type = "checkbox";
      iChk.checked = d.enable != 0;
      iChk.id = "chkDev" + d.addr + "En";
      td.appendChild(iChk);

      td = tr.insertCell(3);
      var iTxt = document.createElement('input');
      iTxt.type = "text";
      iTxt.id = "txtDev" + d.addr + "Value";
      iTxt.value = d.value;
      iTxt.readOnly = true;
      iTxt.className = "textView";
      td.appendChild(iTxt);

      td = tr.insertCell(4);

      var btOn = document.createElement('button');
      btOn.type = "button";
      btOn.innerHTML = "ON";
      btOn.onclick = function () {
        btOnOff_Click(d.addr, 1);
      };
      var btOff = document.createElement('button');
      btOff.type = "button";
      btOff.innerHTML = "OFF";
      btOff.onclick = function () {
        btOnOff_Click(d.addr, 0);
      };
      var div = document.createElement('div');
      div.appendChild(btOn);
      div.appendChild(btOff);

      td.appendChild(div);
    }

    function btOnOff_Click(addr, v) {
      var uri = "io-ct.json?addr=" + addr + "&cmd=" + v;
      jsGET(uri, function (rspText) {
        let j = JSON.parse(rspText);
        let a = j["addr"];
        let v = j["value"];
        jsGetEId("txtDev" + a + "Value").value = v;
      });
    }

    function updateSchedules() {
      for (let i = 0; i < schedules.length; i++) {
        addSchedule(schedules[i]);
      }
    }

    function addSchedule(schd = null) {
      var id = 0;
      var value = "";
      if (schd != null) {
        id = schd.id;
        value = JSON.stringify(schd, ["id", "name", "enable", "mode", "repeat", "days", "times", "addr", "start", "duration", "stop"]);
      } else {
        id = generateScheduleId();
        value = JSON.stringify({
          "id": id,
          "name": "",
          "enable": 1,
          "mode": 0,
          "repeat": 0,
          "days": 127,
          "times": [10000, 30000],
          "addr": 1,
          "start": 1,
          "duration": 0,
          "stop": 0
        });
      }
      value = value.replace(/,"/g, ', "');

      var tb = jsGetEId("tbSchedules");
      var rowIndex = tb.rows.length;
      var tr = tb.insertRow(rowIndex);
      var td;

      td = tr.insertCell(0);
      var iTxt = document.createElement('input');
      iTxt.type = "text";
      iTxt.name = "txtSch" + id + "Id";
      iTxt.value = id;
      iTxt.readOnly = true;
      iTxt.className = "textView";
      td.appendChild(iTxt);

      td = tr.insertCell(1);
      var iTxt = document.createElement('textarea');
      iTxt.style.width = "590px";
      iTxt.name = "txtSch" + id + "Value";
      iTxt.value = value;
      td.appendChild(iTxt);

      td = tr.insertCell(2);
      var btRemove = document.createElement('button');
      btRemove.type = "button";
      btRemove.innerHTML = "Remove";
      btRemove.onclick = function () {
        tb.deleteRow(tr.rowIndex);
      };
      td.appendChild(btRemove);
    }

    function generateScheduleId() {
      try {
        var tb = jsGetEId("tbSchedules");
        var arr = [];
        for (let i = 2; i < tb.rows.length; i++) {
          let tr = tb.rows[i];
          let td = tr.firstChild;
          let txt = td.firstChild;
          arr.push(parseInt(txt.value));
        }
        console.log(arr);
        arr.sort(function (a, b) {
          return b - a
        });
        if (arr.length > 0) {
          return arr[0] + 1;
        }
      } catch (e) {
        console.log("generateScheduleId:" + e);
      }
      return 1;
    }

    function jsSubmit() {
      for (let i = 1; i < 10; i++) {
        jsChk2Txt("chkDev" + i + "En");
      }
      document.forms[0].submit();
    }
  </script>
</head>

<body onload="jsOnLoad();">

  <div id="header">
  </div>

  <div id="nav">
  </div>

  <div id="content">
    <form id="idForm" method="post">
      <table id="tbDevices">
        <tr class="bh">
          <td class="tdh" colspan="5">IO ports</td>
        </tr>
        <tr>
          <th style="width: 100px;">Address</th>
          <th style="width: 200px;">Name</th>
          <th style="width: 100px;">Enable</th>
          <th style="width: 100px;">Value</th>
          <th>Manual Control</th>
        </tr>
      </table>

      <table id="tbSchedules">
        <tr class="bh">
          <td class="tdh" colspan="2">Schedules</td>
        </tr>
        <tr>
          <th style="width: 100px;">ID</th>
          <th style="width: 600px;">Value</th>
          <th><button type="button" onclick="addSchedule()">Add</button></th>
        </tr>
      </table>

      <p style="text-align:left">
        <input type="button" onclick="jsSubmit()" value="Update Settings" />
      </p>
    </form>
  </div>
</body>

</html>