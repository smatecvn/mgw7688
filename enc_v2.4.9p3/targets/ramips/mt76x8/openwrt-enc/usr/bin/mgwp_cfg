#!/bin/sh

# mode: ppp, qmi, ethernet client
# -m ppp -d /dev/ttyUSB2 -a m-wap
# -m qmi -d /dev/cdc-wdm0 -a m-wap
# -m ethernet 

# Validate
if [ -z "$1" ]; then 
  echo "Usage:"
  echo "    ${0} -h                 Display help"
  echo "    ${0} -m operation_mode -a apn_name -d device_node"
  echo " Example: ${0} -m qmi -d /dev/cdc-wdm0 -a m-wap "
  exit 1
fi

# Default settings
APN_NAME='m-wap'
MODE='qmi'
DEVICE_NODE='/dev/cdc-wdm0'

while getopts ":hmda" opt; do
  case ${opt} in
    # Help    
    h )
      echo "Usage:"
      echo "    ${0} -h                 Display help"
      echo "    ${0} -p                 Upgrade package python-mgw"
      exit 0
      ;;

    # Upgrade package -- scan for 2nd pkg if needed
    m )
      
      MODE=$2
     
      ;;

    d )
      # Device: ppp - /dev/ttyUSB2, qmi - /dev/cdc-wdm0
      DEVICE_NODE=$2

      # validate if node is valid
      if [ ! -c $DEVICE_NODE ]; then
        echo "${0} - Invalid node option ${1} "
        exit 1
      fi
      
      ;;

    a )
      APN_NAME=$2
     
      echo "apn name- $APN_NAME"
      ;; 

    # Invalid option
   \? )
     echo "Invalid Option: -$OPTARG" 1>&2
     exit 1
     ;;
  esac
done


## Set operation mode
case $MODE in
  qmi)
    echo "qmi mode"

    # wam interface
    uci delete network.wan
    uci set network.wan=interface
    uci set network.wan.ifname=wwan0
    uci set network.wan.proto=$MODE
    uci set network.wan.device=$DEVICE_NODE
    uci set network.wan.apn=$APN_NAME
    uci set network.wan.modes='umts'
    uci set network.wan.autoconnect='1'

    # Lan interface
    uci delete network.lan
    uci set network.lan=interface
    uci set network.lan.type='bridge'
    uci set network.lan.ifname='eth0'
    uci set network.lan.proto='static'
    uci set network.lan.netmask='255.255.255.0'
    uci set network.lan.ip6assign='60'
    #uci set network.lan.ipaddr='192.168.11.102'
    #uci set network.lan.gateway='192.168.11.1'
    uci set network.lan.dns='8.8.8.8 8.8.4.4'

    uci commit network

    # Enable DHCP
    uci set dhcp.lan.ignore='1'
    uci commit dhcp

    /etc/init.d/dnsmasq restart
    /etc/init.d/odhcpd restart
    ;;  

  ppp)
    echo "ppp mode"

    # Wan
    uci delete network.wan
    uci set network.wan=interface
    uci set network.wan.proto='3g'
    uci set network.wan.device=$DEVICE_NODE
    uci set network.wan.apn=$APN_NAME
    uci set network.wan.service='umts'
    uci set network.wan.dialnumber='*99#'
    uci commit network

    # Enable DHCP
    uci set dhcp.lan.ignore='1'
    uci commit dhcp

    /etc/init.d/dnsmasq restart
    /etc/init.d/odhcpd restart    
    ;;

  ethernet)
    echo "ethernet mode"

    # wan interface
    uci delete network.wan
    uci set network.wan=interface
    uci set network.wan.ifname=wwan0
    uci set network.wan.proto=dhcp

    uci commit network

    # Disable DHCP at LAN
    uci set dhcp.lan.ignore='1'
    uci commit dhcp

    /etc/init.d/dnsmasq restart
    /etc/init.d/odhcpd restart

    ;;
  
  *)
    echo "Invalid mode option, should be ppp, qmi or ethernet"
    exit 2
    ;;
esac

/etc/init.d/network restart

exit 0
