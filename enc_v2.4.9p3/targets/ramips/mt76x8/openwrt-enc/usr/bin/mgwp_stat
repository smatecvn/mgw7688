#!/bin/sh

# Output file name
output_file="/tmp/cpu_usage.txt"

# Initialize total CPU usage
total_cpu=0

# Counter for the number of samples taken
sample_count=0

# Infinite while loop to take samples continuously
while :; do
    # Get CPU usage using the top command
    cpu_sample=$(top -n 1 | grep 'CPU:' | awk '{print $2}')
	cpu_sample_d=$(echo $cpu_sample | tr -d '%')
	
	# Check if cpu_sample_d is greater than 20.0
	if [ $(awk "BEGIN {print ($cpu_sample_d > 20.0)}") -eq 1 ]; then
        cpu_sample_d=20.0
    fi

    # Add the CPU sample to the total
    total_cpu=$(awk "BEGIN {print $total_cpu + $cpu_sample_d}")
	

    # Increment the sample count
    sample_count=$((sample_count + 1))

    # Sleep for 1 second
    sleep 6

    # Calculate and print the average every 10 samples
    if [ $sample_count -eq 10 ]; then
        # Calculate the average CPU usage
        average_cpu=$(awk "BEGIN {print $total_cpu / $sample_count}")

        # Write the result to the output file
		#int_average_cpu=$(echo $average_cpu | awk '{printf "%.0f", $average_cpu}')
		int_average_cpu=$(printf "%.0f\n" $average_cpu)
		echo "CPU: $int_average_cpu%" > $output_file		
        echo "CPU: $int_average_cpu%"
        
        # Reset total CPU and sample count
        total_cpu=0
        sample_count=0
    fi
done
