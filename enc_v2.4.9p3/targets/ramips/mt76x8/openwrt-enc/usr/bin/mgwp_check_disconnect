#!/bin/sh

#mgwp_settings="/root/mgwp/mgwp_settings.json"
#output="/mnt/mmcblk0p1/streaming.log"

# Default Streaming Infomation 
#STREAMING_SERVER="sohoa.truyenthanhthongminh.vn"
#STREAMING_PORT="80"
#MOUNT_POINT="live"
check_server_state(){
	#echo "Download status.json file..."
	cd /tmp
	wget -q -O status.json http://admin:mgw@127.0.0.1:81/status.json
	STATUS_JSON_STR=$(cat status.json | python3 -c "import json,sys;obj=json.load(sys.stdin);print(obj['mobile'])")
	DISCONNECT_CNT=$(echo "${STATUS_JSON_STR}" | awk '{print $2}' |  sed "s/=/ /" | awk '{print $2}')

	#if [ $CONNECT_STATE == "Connected" ]; then
		#echo "connected to server"
	#	retval="true"
	#else
		#echo "disconnected to server"
	#	retval="false"
	#fi
	if [ -z $DISCONNECT_CNT ]; then 
		echo 0
	else
		echo $DISCONNECT_CNT
	fi
}


#echo "Streaming Server: ${STREAMING_SERVER}"
#echo "Streaming Port: ${STREAMING_PORT}"
#echo "Mount Point: ${MOUNT_POINT}"

retval=$( check_server_state )
#echo $retval
newretval=$retval
THRESHOLD=3
#echo "Return value: ${retval}"

#if [ "${retval}" == "true" ]; then
#     echo "connected to server"
#else
#     echo "disconnected to server"
#fi
while true
do
sleep 300
newretval=$( check_server_state )
x=$(($newretval-$retval))
logger "Checking disconnect_cnt"

if [ "$newretval" != "$retval" ]; then
	logger "disconnect_cnt changed: ${retval} -> ${newretval}"	
	retval=$newretval	
	if [ "$x" -ge "$THRESHOLD" ]; then 
		logger "disconnect_cnt >= threshold -> restart app"	
		PYTHON_PID=$(pgrep python)
		if [ -f /proc/$PYTHON_PID/exe ]; then
			kill -9 $PYTHON_PID 
		fi
	else
		logger "disconnect_cnt < threshold -> do nothing"	
	fi
else
	logger "disconnect_cnt no change: ${retval} -> ${newretval}"	
fi

done

